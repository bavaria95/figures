<html>
<head>
<title>Game</title>
</head>
<body>

<style>
@import url('figures.css');
</style>

<button onclick="make()">Make move figures</button>
<button onclick="f()">Remove last figure</button>

<div id="timer">30</div>


<script>
var window_width = window.screen.availWidth;
var window_height = window.screen.availHeight;

var figures = [];
var colors = ['black', 'yellow', 'olive', 'springgreen', 'mediumturquoise', 'navy', 'darkviolet', 'darkorange', 'maroon', 'darkgray', 'brown', 'peach'];
var current_id = 0;
var level = 1;

function getRandomColor() {
	return colors[Math.floor(Math.random() * colors.length)];
}

function Figure(type, id) {
	this.type = type;
	this.id = id;

	this.generate();
	this.move();
	this.addListener();
}

Figure.prototype.generate = function() {
	var pos_x = Math.floor((Math.random() * (window_width - this.bouncyRight - 20)));
	var pos_y = Math.floor((Math.random() * (window_height - this.bouncyBottom - 20)));

	var fig = document.createElement("DIV"); 

	document.body.appendChild(fig);  

	var att = document.createAttribute("class");
	att.value = this.type; 
	fig.setAttributeNode(att);
	
	var att = document.createAttribute("id");
	att.value = "figure" + this.id;
	fig.setAttributeNode(att);

	var att = document.createAttribute("style");
	att.value = "position: absolute; left: " + pos_x + "px;" + "top: " + pos_y + "px;" + this.styleColor;
	fig.setAttributeNode(att);
}


Figure.prototype.move = function() {
	console.log('this during move: ', this);
	var fig = document.getElementById('figure' + this.id);
	console.log('figure:', fig);
	var bouncyBottom = this.bouncyBottom;
	var bouncyRight = this.bouncyRight;
	var bouncyLeft = this.bouncyLeft || 0;
	var bouncyTop = this.bouncyTop || 0;

	var speed_coef = 0.06 * level;

	var x = parseInt(fig.style.left);
	var y = parseInt(fig.style.top);

	var lastTime = null;

	var dx = Math.floor((Math.random() * 10) + 1) * Math.pow(-1, Math.round(Math.random()));
	var dy = Math.floor((Math.random() * 10) + 1) * Math.pow(-1, Math.round(Math.random()));


	function animate(time) {
		var rend_coef = 1;
		if (lastTime != null)
			rend_coef = (lastTime - time) * speed_coef;

    	if ((x + dx < bouncyLeft) || (x + dx > window_width - bouncyRight))
    		dx *= -1;
    	x += dx * rend_coef;

    	if ((y + dy < bouncyTop) || (y + dy > window_height - bouncyBottom))
    		dy *= -1;
    	y += dy * rend_coef;


    	fig.style.left = x + "px";
    	fig.style.top = y + "px";

    	requestAnimationFrame(animate);
  	}
  	requestAnimationFrame(animate);
}

Figure.prototype.remove = function() {
	var fig = document.getElementById('figure' + this.id);
	fig.parentNode.removeChild(fig);

	console.log(figures.length, figures);
	for (var i = 0; i < figures.length; i++)
		if (figures[i].id == this.id) {
			console.log('deleting element: ', i);
			figures.splice(i, 1);
			break;
		}
	console.log(figures.length, figures);
	console.log(figures.length, figures);
}


Figure.prototype.addListener = function() {
	console.log('this.id = ', this.id);
	var figure = document.getElementById('figure' + this.id);
	console.log('figure: ', figure);
	figure.addEventListener("mouseover", function() {
		var id = parseInt(/\d+/.exec(this.id));
		for (var i = 0; i < figures.length; i++)
			if (figures[i].id == id) {
				figures[i].remove();
				break;
			}
	});
}



function Trapezoid(id) {
	this.bouncyBottom = 210;
	this.bouncyRight = 200;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";"
	Figure.call(this, 'trapezoid', id);
}
Trapezoid.prototype = Object.create(Figure.prototype);


function Triangle(id) {
	this.bouncyRight = 95;
	this.bouncyBottom = 210;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";"
	Figure.call(this, 'triangle', id);
}
Triangle.prototype = Object.create(Figure.prototype);


function Circle(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'circle', id);
}
Circle.prototype = Object.create(Figure.prototype);

function Square(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'square', id);
}
Square.prototype = Object.create(Figure.prototype);

function Rectangle(id) {
	this.bouncyRight = 200;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'rectangle', id);
}
Rectangle.prototype = Object.create(Figure.prototype);

function Oval(id) {
	this.bouncyRight = 200;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'oval', id);
}
Oval.prototype = Object.create(Figure.prototype);

function Parallelogram(id) {
	this.bouncyRight = 185;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'parallelogram', id);
}
Parallelogram.prototype = Object.create(Figure.prototype);

function StarSix(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 240;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";";
	Figure.call(this, 'star-six', id);
}
StarSix.prototype = Object.create(Figure.prototype);

function StarFive(id) {
	this.bouncyRight = 195;
	this.bouncyBottom = 280;
	this.styleColor = "";
	Figure.call(this, 'star-five', id);
}
StarFive.prototype = Object.create(Figure.prototype);

function Pentagon(id) {
	this.bouncyRight = 90;
	this.bouncyBottom = 153;
	this.bouncyTop = 28;
	this.styleColor = "";
	Figure.call(this, 'pentagon', id);
}
Pentagon.prototype = Object.create(Figure.prototype);

function Hexagon(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 190;
	this.bouncyTop = 24;
	this.styleColor = "";
	Figure.call(this, 'hexagon', id);
}
Hexagon.prototype = Object.create(Figure.prototype);

function Pacman(id) {
	this.bouncyRight = 105;
	this.bouncyBottom = 225;
	var c = getRandomColor();
	this.styleColor = "border-top: 60px solid " + c + ";border-left: 60px solid " + c + ";border-bottom: 60px solid " + c + ";";
	Figure.call(this, 'pacman', id);
}
Pacman.prototype = Object.create(Figure.prototype);

var shapes = [function(id) {return new Trapezoid(id)}, function(id) {return new Triangle(id)}, function(id) {return new Circle(id)}, function(id) {return new Square(id)}, function(id) {return new Rectangle(id)}, function(id) {return new Oval(id)}, function(id) {return new Parallelogram(id)}, function(id) {return new StarSix(id)}, function(id) {return new StarFive(id)}, function(id) {return new Pentagon(id)}, function(id) {return new Hexagon(id)}, function(id) {return new Pacman(id)}];


function addRandomFigure() {
	figures.push(shapes[Math.floor(Math.random() * shapes.length)](++current_id));
}

function make() {
	var n = 4;
	for (var i = 0; i < n; i++) {
		addRandomFigure();
	}
}

function f() {
	var n = 3;
	for (var i = 0; i < n; i++) {
		addRandomFigure(1);
	}
}

function init(time) {
	sec = time;
	setInterval(tick, 1000);
}
            
function tick() {
    sec--;
    document.getElementById("timer").childNodes[0].nodeValue = sec;
}


init(5);
</script>

</body>
</html>
