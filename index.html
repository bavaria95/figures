<html>
<head>
<title>Game</title>
</head>
<body>

<style>
@import url('figures.css');

body {
	overflow: hidden;
}

#timer {
	position: absolute;
	left: 10px;
	font-size: 300%;
	color: green;
	text-align: left;
}


#score {
	position: absolute;
	font-size: 300%;
	color: red;
	text-align: right;
	bottom: 0;
	right: 10px;
}
</style>



<form id="start_info">
  <center>Nickname <input type="text" name="nickname" placeholder="John Doe"></center><br>
  <center># of figures: <input type="text" name="quant" value="8"></center><br>
</form> 

<center><button onclick="start()" id="go_button">Let's play!</button><center>

<script>
var window_width = window.screen.availWidth;
var window_height = window.screen.availHeight;

var figures = [];
var colors = ['black', 'yellow', 'olive', 'springgreen', 'mediumturquoise', 'navy', 'darkviolet', 'darkorange', 'maroon', 'darkgray', 'brown', 'peach'];
var current_id = 0;
var level = 0;
var score = 0;
var lastTime = 0;

var username;
var numberOfFigures;


function getRandomColor() {
	return colors[Math.floor(Math.random() * colors.length)];
}

function Figure(type, id) {
	this.type = type;
	this.id = id;

	this.generate();
	this.move();
	this.addListener();
}

Figure.prototype.generate = function() {
	var pos_x = Math.floor((Math.random() * (window_width - this.bouncyRight - 30)));
	var pos_y = Math.floor((Math.random() * (window_height - this.bouncyBottom - 30)));

	var fig = document.createElement("DIV"); 

	document.body.appendChild(fig);  

	var att = document.createAttribute("class");
	att.value = this.type; 
	fig.setAttributeNode(att);
	
	var att = document.createAttribute("id");
	att.value = "figure" + this.id;
	fig.setAttributeNode(att);

	var att = document.createAttribute("style");
	att.value = "position: absolute; left: " + pos_x + "px;" + "top: " + pos_y + "px;" + this.styleColor;
	fig.setAttributeNode(att);
}


Figure.prototype.move = function() {
	var fig = document.getElementById('figure' + this.id);

	var bouncyBottom = this.bouncyBottom;
	var bouncyRight = this.bouncyRight;
	var bouncyLeft = this.bouncyLeft || 0;
	var bouncyTop = this.bouncyTop || 0;

	var speed_coef = level;

	var x = parseInt(fig.style.left);
	var y = parseInt(fig.style.top);

	var lastTime = null;

	var dx = Math.floor((Math.random() * 10) + 1) * Math.pow(-1, Math.round(Math.random()));
	var dy = Math.floor((Math.random() * 10) + 1) * Math.pow(-1, Math.round(Math.random()));

	this.speed = Math.sqrt(Math.pow(dx * speed_coef, 2) + Math.pow(dy * speed_coef, 2));

	function animate(time) {

    	if ((x + dx*speed_coef < bouncyLeft) || (x + dx*speed_coef > window_width - bouncyRight))
    		dx *= -1;
    	x += dx * speed_coef;

    	if ((y + dy*speed_coef < bouncyTop) || (y + dy*speed_coef > window_height - bouncyBottom))
    		dy *= -1;
    	y += dy * speed_coef;


    	fig.style.left = x + "px";
    	fig.style.top = y + "px";

    	requestAnimationFrame(animate);
  	}
  	requestAnimationFrame(animate);
}

Figure.prototype.remove = function() {
	var fig = document.getElementById('figure' + this.id);
	fig.parentNode.removeChild(fig);

	for (var i = 0; i < figures.length; i++)
		if (figures[i].id == this.id) {
			figures.splice(i, 1);
			break;
		}
}


Figure.prototype.addListener = function() {
	var figure = document.getElementById('figure' + this.id);
	figure.addEventListener("mouseover", function() {
		var id = parseInt(/\d+/.exec(this.id));
		for (var i = 0; i < figures.length; i++)
			if (figures[i].id == id) {
				score += Math.floor((figures[i].speed * (30 * 1000 - lastTime)) / 1000);
				lastTime = 0;
				figures[i].remove();
				break;
			}
		addRandomFigure();
	});
}



function Trapezoid(id) {
	this.bouncyBottom = 210;
	this.bouncyRight = 200;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";"
	Figure.call(this, 'trapezoid', id);
}
Trapezoid.prototype = Object.create(Figure.prototype);


function Triangle(id) {
	this.bouncyRight = 95;
	this.bouncyBottom = 210;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";"
	Figure.call(this, 'triangle', id);
}
Triangle.prototype = Object.create(Figure.prototype);


function Circle(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'circle', id);
}
Circle.prototype = Object.create(Figure.prototype);

function Square(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'square', id);
}
Square.prototype = Object.create(Figure.prototype);

function Rectangle(id) {
	this.bouncyRight = 200;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'rectangle', id);
}
Rectangle.prototype = Object.create(Figure.prototype);

function Oval(id) {
	this.bouncyRight = 200;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'oval', id);
}
Oval.prototype = Object.create(Figure.prototype);

function Parallelogram(id) {
	this.bouncyRight = 185;
	this.bouncyBottom = 210;
	this.styleColor = "background: " + getRandomColor() + ";";
	Figure.call(this, 'parallelogram', id);
}
Parallelogram.prototype = Object.create(Figure.prototype);

function StarSix(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 240;
	this.styleColor = "border-bottom: 100px solid " + getRandomColor() + ";";
	Figure.call(this, 'star-six', id);
}
StarSix.prototype = Object.create(Figure.prototype);

function StarFive(id) {
	this.bouncyRight = 195;
	this.bouncyBottom = 280;
	this.styleColor = "";
	Figure.call(this, 'star-five', id);
}
StarFive.prototype = Object.create(Figure.prototype);

function Pentagon(id) {
	this.bouncyRight = 90;
	this.bouncyBottom = 153;
	this.bouncyTop = 28;
	this.styleColor = "";
	Figure.call(this, 'pentagon', id);
}
Pentagon.prototype = Object.create(Figure.prototype);

function Hexagon(id) {
	this.bouncyRight = 100;
	this.bouncyBottom = 190;
	this.bouncyTop = 24;
	this.styleColor = "";
	Figure.call(this, 'hexagon', id);
}
Hexagon.prototype = Object.create(Figure.prototype);

function Pacman(id) {
	this.bouncyRight = 105;
	this.bouncyBottom = 225;
	var c = getRandomColor();
	this.styleColor = "border-top: 60px solid " + c + ";border-left: 60px solid " + c + ";border-bottom: 60px solid " + c + ";";
	Figure.call(this, 'pacman', id);
}
Pacman.prototype = Object.create(Figure.prototype);

var shapes = [function(id) {return new Trapezoid(id)}, function(id) {return new Triangle(id)}, function(id) {return new Circle(id)}, function(id) {return new Square(id)}, function(id) {return new Rectangle(id)}, function(id) {return new Oval(id)}, function(id) {return new Parallelogram(id)}, function(id) {return new StarSix(id)}, function(id) {return new StarFive(id)}, function(id) {return new Pentagon(id)}, function(id) {return new Hexagon(id)}, function(id) {return new Pacman(id)}];


function addRandomFigure() {
	figures.push(shapes[Math.floor(Math.random() * shapes.length)](++current_id));
}

var timer;

function init_time(time) {
	ddms = time * 10;
	interval = setInterval(tick, 100);
}
            
function tick() {
    ddms--;
    sec = parseInt(ddms / 10);
    document.getElementById("timer").childNodes[0].nodeValue = sec + "." + (ddms - sec*10);
    if (ddms <= 0)
    	clearInterval(interval);
}


function start() {
	var x = document.forms[0];
	username = x.elements[0].value;
	numberOfFigures = parseInt(x.elements[1].value);

	var form = document.getElementById('start_info');
	form.parentNode.removeChild(form);

	var button = document.getElementById('go_button');
	button.parentNode.removeChild(button);


	level = 1;
	start_level(level, numberOfFigures);
}

function create_timer_view() {
	timer_elem = document.createElement("DIV"); 

	document.body.appendChild(timer_elem);  

	var att = document.createAttribute("id");
	att.value = 'timer'; 
	timer_elem.setAttributeNode(att);

	timer_elem.innerHTML = '30.0';
}

var score_elem;
function create_score_view() {
	score_elem = document.createElement("DIV"); 

	document.body.appendChild(score_elem);  

	var att = document.createAttribute("id");
	att.value = 'score'; 
	score_elem.setAttributeNode(att);
}

function update_score() {
	score_elem.innerHTML = score;
}

function start_level(level, numberOfFigures) {
	for (var i = 0; i < numberOfFigures; i++)
		addRandomFigure();

	create_timer_view();
	create_score_view();

	interval = setInterval(update_score, 100);


	init_time(6);

	setTimeout(function() {
		console.log("Time out!");
	}, 6000)



}


</script>

</body>
</html>
